# Подсистема интеграции с внешними системами

# Введение

### Назначение
Организация обмена данными между 1с и внешними системами, через гибкий механизм обмена с конфигурируемыми под бизнес процессы:
- регистрацией объектов к обмену
- сериализацией объектов
- доставка по различным каналам (HTTP, брокеры сообщений и др.).
Решение построено по принципу расширяемости:
- Основная логика интеграции реализована в виде общих модулей
- Специфические сценарии и доработки выносятся в переопределяемые модули
### Когда  использовать:
- Разветленная схема потоков данных между системами (микросервисы):
    - много источников - много потребителей
    - несколько потребителей для одного источника
		> брокер упрощает схему интеграционных процессов наличием центра маршрутизации
- Используется большое количество маленьких/легковесных сообщений:
    - сообщения уведомлений пользователей
    - использование сильно граннулированных сообщений обмена данными для передачи - например, передача остатков по товарам
        > брокер может не хранить данные на диске, используя только ресурс сети и ОЗУ для передачи данных
        
- Высокие требования к оперативности доставки данных (мгновенные сообщения):
    - передача изменений остатков товаров
        > брокер держит постоянное tcp соединение с потребителем, что позволяет позволяет доставлять данные практически online
## Зависимости решения
- БСП версии 3.0 и старше
- Рекомендуемая версия платформы: 8.3.24.1586 (ведется разработка)
- Разработка в EDT
# Структура подсистемы

## Ключевые элементы

### Справочники
| Имя                                                                   | Назначение                                                                                                                                                   | Пример                                                                                                                                   |
| --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **рдв_ВидыСообщенийИнтеграции**                                       | виды сообщений для обмена между системами                                                                                                                    | контрагенты, номенклатура, регистр служебный. Задаем в правилах регистрации см.*см.рдв_МодульИнтеграцииДемо.ЗаполнитьПравилаРегистрации* |
| **рдв_ВнешниеСистемы**                                                | перечень  доступных внешних систем                                                                                                                           | HTTP-сервисы, брокеры сообщений                                                                                                          |
| **рдв_ВыгружаемыеОбъекты**                                            | контейнер для выгружаемых данных (создается автоматически). Любой выгружаемый объект будет связан со справочником, в том числе наборы независимых регистров. |                                                                                                                                          |
| **рдв_СтатусыИнтеграции**, **рдв_ТипыОчередейОбработкиДанных прочие** | вспомогательные справочники                                                                                                                                  |                                                                                                                                          |

### Общие модули

| Модуль                                          | Назначение                                                                                                                                                                                                                         |
| ----------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `рдв_Интеграция`                                | Главный модуль, управляющий процессом интеграции, маршрутизацией сообщений, обработкой отправки и получения данных. Точки входа для регламентных заданий, маршрутизаторы, обработчики ошибок интеграции и вспомогательные функции. |
| `рдв_ИнтеграцияПереопределяемый`                | Модуль для расширения и переопределения стандартной логики интеграции. Используется для внедрения специфических сценариев, не затрагивая типовую часть.                                                                            |
| `рдв_МенеджерОбмена`                            | Отвечает за правила конвертации данных при обмене между 1С и внешними системами. Содержит функции для инициализации, поиска и добавления правил конвертации объектов и их свойств.                                                 |
| `рдв_МенеджерОбменаПереопределяемый`            | Позволяет расширять и изменять правила конвертации без изменения типовой части. Здесь можно реализовать индивидуальные правила для новых объектов или форматов обмена.                                                             |
| `рдв_РегистрацияИзменений`                      | Модуль для регистрации изменений объектов, подлежащих обмену. Содержит обработчики событий, функции регистрации изменений и вспомогательные процедуры.                                                                             |
| `рдв_РегистрацияИзмененийПереопределяемый`      | Модуль для расширения логики регистрации изменений, например, для добавления новых правил регистрации или обработки нестандартных сценариев.                                                                                       |
| `рдв_ИнтеграцияHTTP`, `рдв_ИнтеграцияRMQ`       | Модули, реализующие работу с конкретными типами внешних систем (HTTP-сервисы, брокеры сообщений RMQ и др.).                                                                                                                        |
| `рдв_...Демо`                                   | Модули с суффиксом Демо содержат примеры реализации интеграции и могут быть использованы как шаблон для разработки новых обработчиков.                                                                                             |
| `рдв_КонтрольЦелостностиДанных`                 | Модуль реализует логику для сверки состояний объектов в разных базах.                                                                                                                                                              |
| `рдв_КонтрольЦелостностиДанныхПереопределяемый` | Модуль реализует возможность задать правила сверки объектов или определить собственный алгоритм.                                                                                                                                   |

### Регистры сведений

| Имя                                   | Назначение                                                                                                                                                             |
| ------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `рдв_СообщенияИнтеграции`             | входящие/исходящие сообщения, участвующие в интеграции                                                                                                                 |
| `рдв_КонтекстСообщенийИнтеграции`     | дополнительный контекст сообщений (данные транспорта). Используется для хранения технической информации, полезной для отладки и мониторинга.                           |
| `рдв_ИдентификаторыОбъектовИсточника` | используется для быстрого сопоставления объектов информационных баз. Первый приоритет за регистром, далее ГУИД объекта, далее правила поиска.                          |
| `рдв_ЖурналОчередейОбработкиДанных`   | вспомогательные регистры для управления процессами обмена и идентификации объектов.                                                                                    |
| `рдв_ХешиСообщенийИнтеграции`         | - недопущение выгрузки одного состояния объекта несколько раз. <br>- контроль полноты и целостности данных (настройка ПВХ - ИнтеграцияКонтролироватьЦелостностьДанных) |

### Подписки на события

| Имя                                                                            | Назначение                                         |
| ------------------------------------------------------------------------------ | -------------------------------------------------- |
| `рдв_ДокументыПриЗаписи, рдв_СправочникиПриЗаписи, рдв_НаборыЗаписейПриЗаписи` | регистрация изменений событий обмена               |
| `рдв_ЖурналСобытийПередЗаписьюСообщения, рдв_ЖурналСобытийПриЗаписиОчереди`    | подписки для регистрации событий в процессе обмена |
### Перечисления

| Имя                                                    | Назначение                                                                      |
| ------------------------------------------------------ | ------------------------------------------------------------------------------- |
| `рдв_ТипыВнешнихСистем`                                | типы внешних систем (HTTP, RMQ и др.).                                          |
| `рдв_СтатусыИнтеграции, рдв_СтатусыОбработкиСообщений` | статусы интеграции и обработки сообщений                                        |
| `рдв_ФорматыОбмена, рдв_ТипыВыгружаемыхОбъектов`       | форматы обмена и типы объектов для выгрузки (ссылки, наборы записей, служебные) |
### Обработки

| Имя                          | Назначение                                                               |
| ---------------------------- | ------------------------------------------------------------------------ |
| `рдв_КомпонентаRabbitMQ`     | обработка для работы с RabbitMQ.                                         |
| `рдв_ОбслуживаниеИнтеграции` | обработка для ручной регистрации изменений, пересчета Хеша               |
| `рдв_КонсольЗапросов`        | консоль для регистрации изменений в обработке рдв_ОбслуживаниеИнтеграции |
# Точки расширения
Архитектура разделена на блоки:
1. Типовая (базовая) логика - не рекомендуется вносить изменения
2. Модифицируемая:
	1. [Демо-реализации] - примеры для решения типовых задач. Модули с суффиксом Демо (рдв_МодульИнтеграцииДемо). // todo навигация
		1. инструкция регистрация изменений объектов для последующей отправки
		2. правила сериализации объектов
		3. правила контроля целостности данных
	2. [Добавление механизма транспорта]
	3. [Сверка полноты и целостности данных]
