# Описание процесса встройки своих методов

Для реализации бизнес логики заказчика для целей интеграции необходимо создать общий модуль который будет реализовывать эту логику.
В качестве шаблона скопировать модуль `рдв_МодульИнтеграцииДемо`. В нем реализованы основные подходы к разработке.
Указать имя созданного модуля в `рдв_ИнтеграцияПереопределяемый.ИмяМодуляБизнесЛогикиИнтеграции`. Это позволит собрать в одном месте все основные вызовы для переопределения не прыгая по конфигурации.
В созданном модуле реализовать следующий программный интерфейс. Полный пример листинга методов в модуле `рдв_МодульИнтеграцииДемо`.

## Правила конвертации
В модуле по примеру `рдв_МодульИнтеграцииДемо` необходимо заполнить правила конвертации объектов участвующих в обмене.

```
#Область МенеджерОбмена

// Позволяет в зависимости от направлений обмена сформировать правила для объектов интеграции.
// 
Процедура ЗаполнитьПравилаКонвертацииОбъектов(СвойстваКонвертации, НаправлениеОбмена) Экспорт

Если НаправлениеОбмена = "Отправка" Тогда

// Пример
ПКО = рдв_МенеджерОбмена.ДобавитьПКО(СвойстваКонвертации, Метаданные.Справочники._ДемоКонтрагенты);
ПКО.ИмяОбъекта = "Справочник.Контрагенты";
ПКО.ИмяПКО = "Справочник_Контрагенты";

КонвертацияШапки = ПКО.КонвертацияШапки;
ИмяРеквизита = "Код";
ИмяКлючаФормата = "Код"; // Представление реквизита в формате обмена
Обязательный = Истина;
рдв_МенеджерОбмена.ДобавитьПКС(КонвертацияШапки, ИмяРеквизита, ИмяКлючаФормата, Обязательный);
...

ИмяТаблЧасти = "КонтактнаяИнформация";
ИмяКлючаФормата = "КонтактнаяИнформация"; // Представлениетреквизита в формате обмена
ТаблЧасть = рдв_МенеджерОбмена.ДобавитьТаблЧасть(СвойстваКонвертации, ПКО, ИмяТаблЧасти, ИмяКлючаФормата);
...

рдв_МенеджерОбмена.ДобавитьПКС(ТаблЧасть, "Представление", "Представление");

ПоляПоиска = ПКО.ПоляПоиска;
рдв_МенеджерОбмена.ДобавитьПоляПоиска(ПоляПоиска, "Код");

КонецПроцедуры

// Для целей формирования сообщения обмена
// добавит имя базы в сообщение обмена
// meta.baseid
Функция ИмяИБ() Экспорт
	Возврат "Узел1";
КонецФункции

#КонецОбласти

```

# Работа с событиями и регистрацией изменений

В системе реализован механизм автоматической регистрации изменений объектов, подлежащих обмену с внешними системами. Это достигается с помощью подписок на события и специальных обработчиков, которые фиксируют изменения и формируют сообщения для интеграции.
### Настройка правил регистрации

Для каждого объекта интеграции необходимо указать правила регистрации, которые будут определять для каких внешних источников регистрировать объект. Один объект может участвовать в неограниченом количестве внешних источников.
Так же в `рдв_МодульИнтеграцииДемо`.

```
#Область РегистрацияИзменений

// Правила регистрации объектов для обмена в интеграции.
// При изменении объекта, будет зарегистрирован в указанной внешней системе
// по указаным параметрам
Процедура ЗаполнитьПравилаРегистрации(ПравилаРегистрации) Экспорт
		
	RMQ = Справочники.рдв_ВнешниеСистемы.Предопределенный("RMQ");
	
	ДобавитьПравилоРегистрации(ПравилаРегистрации, 
								Метаданные.Справочники._ДемоКонтрагенты, 
								RMQ, 
								"RMQ",
								"RMQ",
								"exchange",
								"Контрагенты" - для целей маршрутизации брокера
								);
								
КонецПроцедуры

Процедура ДобавитьПравилоРегистрации(ПравилаРегистрации, 
										МетаданныеОбъекта, 
										ВнешняяСистема,  
										ПредставлениеИнтерфейса = "", 
										АдресМетода = "", 
										ИмяВидаСообщения = "")

	ВидСообщения = Неопределено;
	
	Если ЗначениеЗаполнено(ИмяВидаСообщения) Тогда
		ВидСообщения = Справочники.рдв_ВидыСообщенийИнтеграции.ПолучитьВидСообщения(ИмяВидаСообщения);
	КонецЕсли;
											
	ПравилоРегистрации = ПравилаРегистрации.Добавить();
	ПравилоРегистрации.МетаданныеОбъекта = МетаданныеОбъекта;
	ПравилоРегистрации.ВнешняяСистема = ВнешняяСистема;
	ПравилоРегистрации.АдресМетода = АдресМетода;
	ПравилоРегистрации.ВидСообщения = ВидСообщения;
	
КонецПроцедуры

#КонецОбласти
```

```
#Область ОбработчикиСобытий

// Подписка на событие при записи
// установлена на все типы ссылок, 
// можно ограничить до объектов участвующих в обмене
Процедура СправочникиПриЗаписи(Источник, Отказ) Экспорт

	ТипИсточника = ТипЗнч(Источник);
	Если Не ТипИсточника = Тип("СправочникОбъект._ДемоКонтрагенты") Тогда
		Возврат;
	КонецЕсли;

	// Если регистрировать сразу в РегистрацияИзменений
	рдв_РегистрацияИзменений.ЗарегистрироватьИзменения(Источник);
	// Если регистрировать через ОчередиОбработкиДанных
	// с последующей регистрацией в РегистрацияИзменений
	ВыгружаемыйОбъект = Справочники.рдв_ВыгружаемыеОбъекты.ВыгружаемыйОбъект(Источник);
	Если ВыгружаемыйОбъект = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	рдв_РаботаСОчередями.ДобавитьВОчередь(ИмяОчередиИнтеграции(), ВыгружаемыйОбъект);
	
КонецПроцедуры

Процедура ДокументыПриЗаписи(Источник, Отказ) Экспорт
	
	// см.СправочникиПриЗаписи()

КонецПроцедуры

Процедура НаборыЗаписейПриЗаписи(Источник, Отказ, Замещение) Экспорт
	
	// см.СправочникиПриЗаписи()
	
КонецПроцедуры

#КонецОбласти
```

## Итого по модулю

- В созданном модуле должны быть реализованы следующие методы:
 ```
Процедура ЗаполнитьПравилаКонвертацииОбъектов(СвойстваКонвертации, НаправлениеОбмена) Экспорт
Функция ИмяИБ() Экспорт
Процедура СправочникиПриЗаписи(Источник, Отказ) Экспорт
Процедура ДокументыПриЗаписи(Источник, Отказ) Экспорт
Процедура НаборыЗаписейПриЗаписи(Источник, Отказ, Замещение) Экспорт
Процедура ЗаполнитьПравилаРегистрации(ПравилаРегистрации) Экспорт
 ```

Подорбнее [о процессе регистрации](5%20process%20of%20reg%20of%20changes.md)