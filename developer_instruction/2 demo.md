# Описание процесса встройки своих методов

Для реализации бизнес логики заказчика для целей интеграции необходимо создать 3 общих модуля которые будут ее реализовывать.

Модули:
- Шаблон `рдв_МодульИнтеграцииДемо` - основная логика интеграции.
- Шаблон `рдв_ФормированиеХешейОбъектовДемо` - расчет хеша объектов для целей сверки полноты и точности данных.
- Шаблон `рдв_РаботаСОчередямиДемо` - обработка очередей интеграции

Созданные модули необходимо прописать в `рдв_ИнтеграцияПереопределяемый`
- имя аналога `рдв_МодульИнтеграцииДемо` в методе `ИмяМодуляБизнесЛогикиИнтеграции`
- имя аналога `рдв_ФормированиеХешейОбъектовДемо` в методе `ИмяМодуляБизнесЛогикиФормированияХешей`
- имя аналога `рдв_РаботаСОчередямиДемо` в методе `ИмяМодуляБизнесЛогикиОчередей`

Действия выше позволят переопределить в одном месте ключевые вызовы.

# `рдв_МодульИнтеграцииДемо`

## Правила конвертации
В модуле на основании шаблона `рдв_МодульИнтеграцииДемо` необходимо заполнить правила конвертации объектов участвующих в обмене.

```
#Область МенеджерОбмена

// Позволяет в зависимости от направлений обмена сформировать правила для объектов интеграции.
// 
Процедура ЗаполнитьПравилаКонвертацииОбъектов(СвойстваКонвертации, НаправлениеОбмена) Экспорт

Если НаправлениеОбмена = "Отправка" Тогда

// Пример
ПКО = рдв_МенеджерОбмена.ДобавитьПКО(СвойстваКонвертации, Метаданные.Справочники._ДемоКонтрагенты);
ПКО.ИмяОбъекта = "Справочник.Контрагенты";
ПКО.ИмяПКО = "Справочник_Контрагенты";

КонвертацияШапки = ПКО.КонвертацияШапки;
ИмяРеквизита = "Код";
ИмяКлючаФормата = "Код"; // Представление реквизита в формате обмена
Обязательный = Истина;
рдв_МенеджерОбмена.ДобавитьПКС(КонвертацияШапки, ИмяРеквизита, ИмяКлючаФормата, Обязательный);
...

ИмяТаблЧасти = "КонтактнаяИнформация";
ИмяКлючаФормата = "КонтактнаяИнформация"; // Представлениетреквизита в формате обмена
ТаблЧасть = рдв_МенеджерОбмена.ДобавитьТаблЧасть(СвойстваКонвертации, ПКО, ИмяТаблЧасти, ИмяКлючаФормата);
...

рдв_МенеджерОбмена.ДобавитьПКС(ТаблЧасть, "Представление", "Представление");

ПоляПоиска = ПКО.ПоляПоиска;
рдв_МенеджерОбмена.ДобавитьПоляПоиска(ПоляПоиска, "Код");

КонецПроцедуры

// Для целей формирования сообщения обмена
// добавит имя базы в сообщение обмена
// meta.baseid
Функция ИмяИБ() Экспорт
	Возврат "Узел1";
КонецФункции

#КонецОбласти

```

# Работа с событиями и регистрацией изменений

В системе реализован механизм автоматической регистрации изменений объектов, подлежащих обмену с внешними системами. Это достигается с помощью подписок на события и специальных обработчиков, которые фиксируют изменения и формируют сообщения для интеграции.
### Настройка правил регистрации

Для каждого объекта интеграции необходимо указать правила регистрации, которые будут определять для каких внешних источников регистрировать объект. Один объект может участвовать в неограниченом количестве внешних источников.
Так же в модуле по примеру `рдв_МодульИнтеграцииДемо`.

```
#Область РегистрацияИзменений

// Правила регистрации объектов для обмена в интеграции.
// При изменении объекта, будет зарегистрирован в указанной внешней системе
// по указаным параметрам
Процедура ЗаполнитьПравилаРегистрации(ПравилаРегистрации) Экспорт
		
	RMQ = Справочники.рдв_ВнешниеСистемы.Предопределенный("RMQ");
	
	ДобавитьПравилоРегистрации(ПравилаРегистрации, 
								Метаданные.Справочники._ДемоКонтрагенты, 
								RMQ, 
								"RMQ",
								"RMQ",
								"exchange",
								"Контрагенты" - для целей маршрутизации брокера
								);
								
КонецПроцедуры

Процедура ДобавитьПравилоРегистрации(ПравилаРегистрации, 
										МетаданныеОбъекта, 
										ВнешняяСистема,  
										ПредставлениеИнтерфейса = "", 
										АдресМетода = "", 
										ИмяВидаСообщения = "")

	ВидСообщения = Неопределено;
	
	Если ЗначениеЗаполнено(ИмяВидаСообщения) Тогда
		ВидСообщения = Справочники.рдв_ВидыСообщенийИнтеграции.ПолучитьВидСообщения(ИмяВидаСообщения);
	КонецЕсли;
											
	ПравилоРегистрации = ПравилаРегистрации.Добавить();
	ПравилоРегистрации.МетаданныеОбъекта = МетаданныеОбъекта;
	ПравилоРегистрации.ВнешняяСистема = ВнешняяСистема;
	ПравилоРегистрации.АдресМетода = АдресМетода;
	ПравилоРегистрации.ВидСообщения = ВидСообщения;
	
КонецПроцедуры

#КонецОбласти
```

```
#Область ОбработчикиСобытий

// Подписка на событие при записи
// установлена на все типы ссылок, 
// можно ограничить до объектов участвующих в обмене
Процедура СправочникиПриЗаписи(Источник, Отказ) Экспорт

	ТипИсточника = ТипЗнч(Источник);
	// Отслеживаем только интересующие типы данных
	Если Не ТипИсточника = Тип("СправочникОбъект._ДемоКонтрагенты") Тогда
		Возврат;
	КонецЕсли;

	рдв_РегистрацияИзменений.ЗарегистрироватьИзменения(Источник);
	
КонецПроцедуры

Процедура ДокументыПриЗаписи(Источник, Отказ) Экспорт
	
	// см.СправочникиПриЗаписи()

КонецПроцедуры

Процедура НаборыЗаписейПриЗаписи(Источник, Отказ, Замещение) Экспорт
	
	// см.СправочникиПриЗаписи()
	
КонецПроцедуры

#КонецОбласти
```
Подорбнее [о процессе регистрации](5%20process%20of%20reg%20of%20changes.md)

## Итого по модулю `рдв_МодульИнтеграцииДемо`

- В созданном модуле должны быть реализованы следующие методы:
 ```
Процедура ЗаполнитьПравилаКонвертацииОбъектов(СвойстваКонвертации, НаправлениеОбмена) Экспорт
Функция ИмяИБ() Экспорт
Процедура СправочникиПриЗаписи(Источник, Отказ) Экспорт
Процедура ДокументыПриЗаписи(Источник, Отказ) Экспорт
Процедура НаборыЗаписейПриЗаписи(Источник, Отказ, Замещение) Экспорт
Процедура ЗаполнитьПравилаРегистрации(ПравилаРегистрации) Экспорт
 ```

# Контроль целостности данных

[контроль целостности данных](4%20check%20that%20data%20fine.md)